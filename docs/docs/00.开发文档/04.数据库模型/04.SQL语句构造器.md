---
title: SQL语句构造器
date: 2022-05-08 20:38:46
permalink: /pages/f985b7/
author: 
  name: Ankio
  link: https://github.com/dreamncn
article: false


---

## 语句开始/结尾

我们一共封装了四种开始语句

```
 select/update/delete/insert #用于规定语句类型
```

和一种结束语句

```
commit #用于提交查询/修改
```

**示例：**

查询所有数据

```php
$this->select()->commit();
```

删除一个数据

```php
$this->delete()->where(['id'=>1])->commit();
```

其中，查询语句(`select`)返回的是查询到的数组，如果查询结果为空，则返回空数组。

删除语句(`delete`)与更新语句(`update`)返回影响的行数，返回0则表示无影响。

增加语句(`insert`)返回的数据总量。

## 公共部分

### table()

::: tip 指定使用的数据表
:::

| 参数       | 类型          | 解释                                                         |
| ---------- | ------------- | ------------------------------------------------------------ |
| $tableName | string | 数据表的名称 |


### where()

::: tip 查询条件
:::

| 参数       | 类型   | 解释                                             |
| ---------- | ------ | ------------------------------------------------ |
| $conditions | array  | 条件数组                 |

**条件数组举例**

```php
[
  "id>:id",//此处:id做占位符
  ":id"=>1,//此处标记:id所占位置的值
  "name like :name",//:name做占位符
  ":name"=>'%网%',//标记:name所占位置的值
  "state"=>1,//对于 ’state=1‘这种条件，也可以使用这种方法指定
]
```

**`where...in`语句优化**
::: tip
在传统的参数绑定中，`where...in`语句必须写成下面的写法才能正常解析（PDO的机制导致）
:::
```php
[
  "id in (:id1,:id2)",
  ":id1"=>1,
  ":id2"=>2
]
```
::: tip
经过`CleanPHP`解析后，只需要写成如下即可
:::
```php
[
  "id in (:id)",
  ":id"=>"1,2"
]
```


**`like`语句优化**

::: tip
在传统的参数绑定中，`like`语句必须写成下面这种才能正常执行（PDO的机制导致）
:::
```php
[
  "name like :like",
  ":like"=>"%hello%",
]
```
::: tip
经过`CleanPHP`解析后，只需要写成如下即可
:::
```php
[
  "name like %:like",
  ":like"=>"hello",
  "name2 like '%:like'",//这里无论加不加引号都可以
  ":like2"=>"hello",
]
```

### commit()

::: tip 提交查询语句
`select`中返回的是查询的数组。

`insert`中返回的当前插入数据的唯一ID，要求唯一字段必须自增，否则返回0。

其余返回的是影响的行数。
:::

::: warning
如果没有特别说明，下面的各种方法都需要加上`commit`进行提交。
:::

## 查询语句

### select()
::: tip
标记使用查询语句
:::

### limit()

::: tip 与SQL语句中的 limit 用法一致
:::
| 参数  | 类型   | 解释 |
| ----- | ------ | ---- |
| start | int | 起始位置 |
| end | int | 终止位置 |

::: warning 返回值
如果不设置 `end` 参数，则返回 start 条记录。

如果设置了 `end` 参数，则从第 start 条记录开始, 返回 end 条记录。
:::

### page()
::: tip 执行分页
:::

| 参数  | 类型   | 解释                                                 |
| ----- | ------ | ---------------------------------------------------- |
| start | int    | 分页开始的页数，就是第几页                           |
| count | int    | 每一页显示的数量                                     |
| range | int    | 页面显示范围，最多显示多少页                         |

开启分页并提交查询后，使用[getPage()](03.数据库操作.md#model-getpage)函数获取分页信息。

### orderBy()

::: tip 排序方式
该函数支持多次调用，来实现按照多个字段进行排序
:::

| 参数       | 类型   | 解释                                                         |
| ---------- | ------ | ------------------------------------------------------------ |
| $string | string | 排序字段 |
| $type | string | 排序方式，使用常量`Select::DESC`（降序）和`Select::ASC`（升序）来指定|

### groupBy()

::: tip 按照某个字段进行分组
:::

| 参数       | 类型   | 解释                                                         |
| ---------- | ------ | ------------------------------------------------------------ |
| $string | string | 分组字段 |



### count()

::: tip 统计查出来的数据的总数
该方法不需要[commit](#commit)提交
:::

| 参数       | 类型   | 解释                                                         |
| ---------- | ------ | ------------------------------------------------------------ |
| $conditions | array | 统计条件，与[Where语句](#where) 中的条件数组格式一样|

::: warning 返回值
返回值为为数据总数
:::
### sum()

::: tip 对某个字段进行求和
该方法不需要[commit](#commit)提交
:::

| 参数       | 类型   | 解释                                                         |
| ---------- | ------ | ------------------------------------------------------------ |
| $conditions | array | 求和条件，与[Where语句](#where) 中的条件数组格式一样|
| $param | string | 求和字段|

::: warning 返回值
返回值为某个字段的和
:::


## 更新语句

### update()

::: tip 标记使用更新方法
:::


### set()

::: tip 设置更新字段信息
:::

| 参数 | 类型  | 解释                   |
| ---- | ----- | ---------------------- |
| $row  | array | 直接指定需要更新的数组 |

数组举例：

```php
[
  "id"=>1, //前者为更新字段，后者为需要更新的值
  "name"=>'3333'
]
```



## 插入语句

### insert()

::: tip 标记插入语句
:::


| 参数 | 类型  | 解释                   |
| ---- | ----- | ---------------------- |
| $model | string | insert模式 |

**insert模式如下**

`Insert::NORMAL`：使用常规模式进行插入，遇到主键相同直接报错

`Insert::IGNORE`： 使用忽略模式进行插入，遇到主键相同直接忽略不做修改

`Insert::DUPLICATE`： 使用Duplicate模式进行插入，遇到主键相同时，根据给定的[更新键名](#keys)进行数据更新

### keys()

::: tip insert的键名
:::

::: warning
该方法需要与[values()](#values)联合使用。
:::

| 参数   | 类型  | 解释                                                         |
| ------ | ----- | ------------------------------------------------------------ |
| $key    | array | 需要插入的字段名                                             |
| $colums | array | 需要更新的字段名，只有在insert参数为**Insert::DUPLICATE**时有效 |

`$colums`字段举例：
```php
$this->keys(
  ["id","name"],//需要插入的字段名称为id和name
  ["name"]//如果遇到主键相同的，则更新name字段
)
```

### values()

::: tip insert的键值
:::

::: warning
该方法需要与[keys()](#keys)联合使用。
:::

| 参数 | 类型  | 解释                     |
| ---- | ----- | ------------------------ |
| $row  | array | 二级数组，需要插入的内容 |

**举个例子**

需要插入如下两条数据：

| id   | Name  | Year |
| ---- | ----- | ---- |
| 1    | admin | 2009 |
| 2    | user  | 2012 |

那么[keys()](#keys)所需参数为

```php
['id','name','year']
```

[values()](#values)所需参数为

```php
[
  [1,'admin','2009'],
  [2,'user','2012']
]
```
::: warning
即便只需要插入一条数据，也需要保持双层数组。

只插入一条数据可以使用[keyValue](#keyvalue)来处理。
:::

### keyValue()

::: tip 这是为了解决上面keys和values插入一条语句比较麻烦的问题的方法
:::

::: warning
该方法**不需要**与[values()](#values)和[keys()](#keys)联合使用。
:::

| 参数   | 类型  | 解释                                                         |
| ------ | ----- | ------------------------------------------------------------ |
| $kv    | array | 需要插入的键值对数组                                             |
| $udpKey | array | 需要更新的字段名，只有在insert参数为**Insert::DUPLICATE**时有效 |

`$udpKey`字段的使用方法与[keys()](#keys)中`$colums`字段的使用方法一致。

`$kv`字段举例
```php
[
  "id"=>1,//前者为需要赋值的字段，后者为值
  "name"=>"hello"
]
```


## 删除语句

### delete()

::: tip 标记使用删除语句
:::
